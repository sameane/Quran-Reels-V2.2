import { FFmpeg } from '@ffmpeg/ffmpeg';
import { fetchFile, toBlobURL } from '@ffmpeg/util';

let ffmpegInstance: FFmpeg | null = null;

/**
 * Initialize FFmpeg.wasm instance
 */
export const initFFmpeg = async (): Promise<FFmpeg> => {
  if (ffmpegInstance && ffmpegInstance.loaded) {
    return ffmpegInstance;
  }

  ffmpegInstance = new FFmpeg();
  
  const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/esm';
  await ffmpegInstance.load({
    coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
    wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
  });
  
  return ffmpegInstance;
};

/**
 * Perform deep transcoding to ensure social media compatibility
 * Based on DEEP_TRANSCODE_LOGIC.md specifications
 */
export const performDeepTranscode = async (
  inputBlob: Blob,
  inputFileName: string = 'input.webm',
  outputFileName: string = 'output.mp4',
  onProgress?: (progress: number) => void
): Promise<Blob> => {
  try {
    const ffmpeg = await initFFmpeg();
    
    // Set up progress callback if provided
    if (onProgress) {
      ffmpeg.on('progress', (event: any) => {
        const ratio = event?.ratio || 0;
        const progress = Math.round(ratio * 100);
        onProgress(progress);
      });
    }
    
    // Write input file to FFmpeg memory
    await ffmpeg.writeFile(inputFileName, await fetchFile(inputBlob));
    
    // Execute deep transcoding with social media compatible settings
    await ffmpeg.exec([
      '-i', inputFileName,
      '-c:v', 'libx264',
      '-c:a', 'aac',
      '-pix_fmt', 'yuv420p',
      '-profile:v', 'baseline',
      '-level', '3.0',
      '-movflags', '+faststart',
      '-r', '30',
      '-b:v', '2500k',
      '-b:a', '128k',
      '-ar', '44100',
      '-preset', 'medium',
      outputFileName
    ]);
    
    // Read the processed file
    const data = await ffmpeg.readFile(outputFileName);
    
    // Create blob with MP4 MIME type
    const uint8Array = new Uint8Array(data as Uint8Array);
    const mp4Blob = new Blob([uint8Array], { type: 'video/mp4' });
    
    return mp4Blob;
  } catch (error) {
    console.error('FFmpeg transcoding error:', error);
    throw new Error(`Failed to transcode video: ${error}`);
  }
};

/**
 * Check if FFmpeg is loaded and ready
 */
export const isFFmpegReady = (): boolean => {
  return ffmpegInstance !== null && ffmpegInstance.loaded;
};

/**
 * Clean up FFmpeg instance
 */
export const cleanupFFmpeg = async (): Promise<void> => {
  if (ffmpegInstance) {
    try {
      await ffmpegInstance.terminate();
      ffmpegInstance = null;
    } catch (error) {
      console.warn('Error cleaning up FFmpeg:', error);
    }
  }
};